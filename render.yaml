# Render deployment configuration for CryptoUniverse Enterprise
services:
  # Backend API Service
  - type: web
    name: cryptouniverse-backend
    runtime: python
    plan: pro  # Professional tier for production workload
    region: oregon  # Choose region closest to your users
    buildCommand: pip install fastapi==0.104.1 uvicorn==0.24.0 pydantic==2.5.1 python-dotenv==1.0.0
    startCommand: python app-minimal.py
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      - key: DATABASE_URL
        fromDatabase:
          name: cryptouniverse-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: cryptouniverse-redis
          property: connectionString
      - key: CORS_ORIGINS
        value: https://cryptouniverse-frontend.onrender.com
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 8000
      - key: WORKERS
        value: 4
      - key: LOG_LEVEL
        value: INFO
      - key: PYTHONPATH
        value: /opt/render/project/src
    healthCheckPath: /api/v1/status
    autoDeploy: true
    
  # Redis Cache Service
  - type: redis
    name: cryptouniverse-redis
    plan: pro  # Professional Redis instance
    region: oregon
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Allow access from backend service
    
  # Background Worker Service (for autonomous trading)
  - type: worker
    name: cryptouniverse-worker
    runtime: python
    plan: pro
    region: oregon
    buildCommand: pip install fastapi==0.104.1 uvicorn==0.24.0 pydantic==2.5.1 python-dotenv==1.0.0
    startCommand: python -m app.services.background_worker
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: cryptouniverse-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: cryptouniverse-redis
          property: connectionString
      - key: WORKER_TYPE
        value: autonomous_trading
    autoDeploy: true

databases:
  # PostgreSQL Database
  - name: cryptouniverse-db
    plan: pro  # Professional database tier
    region: oregon
    databaseName: cryptouniverse
    user: cryptouniverse
    postgresMajorVersion: 15

  # Frontend Static Site
  - type: static
    name: cryptouniverse-frontend
    region: oregon
    plan: starter
    buildCommand: npm install && npm run build
    staticPublishPath: ./frontend/dist
    envVars:
      - key: VITE_API_URL
        value: https://cryptouniverse-backend.onrender.com/api/v1
    routes:
      - type: rewrite
        source: /api/*
        destination: https://cryptouniverse-backend.onrender.com/api/*
      - type: rewrite
        source: /*
        destination: /index.html

# Static Site Configuration (Frontend)
# Note: This will be configured separately in Render dashboard
# or via separate render-frontend.yaml